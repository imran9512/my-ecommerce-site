<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:sans-serif;margin:0;padding:40px;max-width:900px}
    label{font-weight:600;display:block;margin:8px 0 2px}
    input,textarea,select{width:100%;padding:6px;margin-bottom:10px}
    button{padding:8px 16px;margin-right:8px;cursor:pointer}
    .section{margin-bottom:30px}
  </style>
</head>
<body>

<!--  LOGIN  -->
<div id="login">
  <h1>Admin Login</h1>
  <button onclick="login()">Login with GitHub</button>
</div>

<!--  FORM  -->
<div id="panel" style="display:none">
  <h1>Admin – Products</h1>
  <select id="productSelect">
    <option value="">-- Select Product --</option>
    <option value="new">➕ Add New Product</option>
  </select>
  <form id="form"></form>
</div>

<script>
/* ---------- CONFIG ---------- */
const repo = 'imran9512/my-ecommerce-site'; // ← your repo
const branch = 'main';
const filePath = 'src/data/products.js';
const clientId = 'Ov23liigiC0PS07gHcCK';  // ← GitHub App client_id
const redirectUri = window.location.origin.replace(/\/$/, '') + '/admin/index.html';

/* ---------- OAuth helper ---------- */
function login() {
  const url =
    'https://github.com/login/oauth/access_token' +
    '?client_id=' + clientId +
    '&redirect_uri=' + encodeURIComponent(redirectUri) +
    '&scope=repo';
  window.location.href = url;
}

/* ---------- token from URL ---------- */
function getTokenFromUrl() {
  const params = new URLSearchParams(window.location.search);
  return params.get('access_token');
}

/* ---------- store / retrieve ---------- */
function store(token) { localStorage.setItem('ghToken', token); }
function retrieve() { return localStorage.getItem('ghToken'); }

/* ---------- init ---------- */
const token = getTokenFromUrl() || retrieve();
if (token) {
  store(token);
  document.getElementById('login').style.display = 'none';
  document.getElementById('panel').style.display = 'block';
  loadProducts(token);
} else {
  /* show GitHub token input manually for now */
  const div = document.getElementById('login');
  div.innerHTML += '<br><input id="tokenInput" placeholder="Paste GitHub token"><button onclick="storeAndGo()">Go</button>';
  window.storeAndGo = () => {
    const t = document.getElementById('tokenInput').value.trim();
    if (t) { store(t); window.location.reload(); }
  };
}

/* ---------- load products ---------- */
async function loadProducts(token) {
  const res = await fetch(`https://raw.githubusercontent.com/${repo}/${branch}/${filePath}`);
  const text = await res.text();
  window.products = eval(text.replace('export default', ''));
  populateSelector(window.products);
}

/* ---------- dropdown ---------- */
function populateSelector(list) {
  const sel = document.getElementById('productSelect');
  sel.innerHTML = '<option value="">-- Select Product --</option><option value="new">➕ Add New Product</option>';
  list.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id;
    opt.textContent = `${p.id} - ${p.name}`;
    sel.appendChild(opt);
  });
  sel.addEventListener('change', handleSelect);
}

/* ---------- show form ---------- */
function handleSelect(e) {
  const id = e.target.value;
  const prod = id === 'new' ? newProduct() : window.products.find(p => p.id === id);
  buildForm(prod);
}

/* ---------- empty skeleton ---------- */
function newProduct() {
  const maxId = window.products.length ? Math.max(...window.products.map(p => +p.id)) : 0;
  return {
    id: String(maxId + 1).padStart(3, '0'),
    slug: '',
    name: '',
    active: true,
    categories: [],
    sku: '',
    stock: 0,
    rating: 0,
    reviewCount: 0,
    images: [],
    price: 0,
    offerPrice: 0,
    qtyDiscount: {},
    shortDesc: '',
    longDesc: '',
    specialNote: '',
    related: [],
    metaTitle: '',
    metaDescription: '',
    ActiveSalt: '',
    reviews: []
  };
}

/* ---------- build form ---------- */
function buildForm(prod) {
  const form = document.getElementById('form');
  form.innerHTML = '';
  Object.entries(prod).forEach(([k, v]) => {
    const lbl = document.createElement('label'); lbl.textContent = k;
    form.appendChild(lbl);
    let input;
    if (typeof v === 'boolean') {
      input = document.createElement('input'); input.type = 'checkbox'; input.checked = v;
    } else if (typeof v === 'number') {
      input = document.createElement('input'); input.type = 'number'; input.value = v;
    } else if (k === 'qtyDiscount') {
      input = document.createElement('textarea'); input.rows = 3; input.value = JSON.stringify(v, null, 2);
    } else if (['longDesc', 'metaDescription', 'specialNote'].includes(k)) {
      input = document.createElement('textarea'); input.rows = 3; input.value = v;
    } else {
      input = document.createElement('input'); input.type = 'text'; input.value = Array.isArray(v) ? v.join(', ') : v;
    }
    input.name = k;
    form.appendChild(input);
  });
  const saveBtn = document.createElement('button');
  saveBtn.textContent = 'Save to GitHub';
  saveBtn.onclick = () => saveProduct(prod);
  form.appendChild(saveBtn);
}

/* ---------- save ---------- */
async function saveProduct(prod) {
  const token = retrieve();
  if (!token) return alert('Not logged in');

  const form = document.getElementById('form');
  const data = {};
  [...form.elements].forEach(el => {
    if (!el.name) return;
    let val = el.type === 'checkbox' ? el.checked : el.value;
    if (['categories', 'related', 'images'].includes(el.name)) val = val.split(',').map(s => s.trim()).filter(Boolean);
    if (el.name === 'qtyDiscount') try { val = JSON.parse(val); } catch { val = {}; }
    if (['stock', 'price', 'rating', 'reviewCount'].includes(el.name)) val = Number(val);
    data[el.name] = val;
  });

  const updated = [...window.products.filter(p => p.id !== data.id), data];
  const content = `export default ${JSON.stringify(updated, null, 2)};`;

  const shaRes = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}?ref=${branch}`);
  const { sha } = await shaRes.json();

  const body = { message: 'Admin update', content: btoa(content), sha, branch };
  const putRes = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
    method: 'PUT',
    headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });

  if (putRes.ok) {
    alert('✅ Saved!');
    window.location.reload();
  } else {
    alert('❌ ' + (await putRes.json()).message);
  }
}
</script>
</body>
</html>