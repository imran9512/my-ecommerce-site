<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body{font-family:sans-serif;margin:0;padding:40px;max-width:900px}
    button{padding:8px 16px;cursor:pointer}
  </style>
</head>
<body>

<div id="root">
  <p>Loading…</p>
</div>

<!-- NextAuth client bundle -->
<script src="https://cdn.jsdelivr.net/npm/next-auth@4.24.11/client/index.js"></script>
<script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
<script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>

<script type="module">
  /* React mini-app */
  const { useEffect, useState } = React;
  const { useSession, signIn } = NextAuth;

  function AdminApp() {
    const { data: session, status } = useSession();

    if (status === 'loading') return <p>Loading…</p>;
    if (!session) return (
      <>
        <h1>Admin Login</h1>
        <button onClick={() => signIn('github')}>Login with GitHub</button>
      </>
    );

    /* ↓ full product form can go here ↓ */
    return <p>Logged-in admin panel coming next…</p>;
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<AdminApp />);
</script>

<script type="module">
  /* ---------- helper ---------- */
  const repo = 'imran9512/my-ecommerce-site';   // ← your repo
  const branch = 'main';
  const filePath = 'src/data/products.js';

  let products = [];
  let token = localStorage.getItem('ghToken');

  /* ---------- OAuth helper ---------- */
  function login() {
    const clientId = 'Ov23liigiC0PS07gHcCK';
    const redirectUri = location.origin + '/api/auth/callback/github';
    const url =
      'https://github.com/login/oauth/authorize' +
      '?client_id=' + clientId +
      '&redirect_uri=' + encodeURIComponent(redirectUri) +
      '&scope=repo';
    window.location.href = url;
  }

  /* ---------- load products ---------- */
  async function loadProducts() {
    if (!token) { login(); return; }
    const res = await fetch(`https://raw.githubusercontent.com/${repo}/${branch}/${filePath}`);
    const text = await res.text();
    products = eval(text.replace('export default', ''));
    renderSelector(products);
  }

  /* ---------- dropdown ---------- */
  function renderSelector(list) {
    const select = document.getElementById('productSelect') || document.createElement('select');
    select.id = 'productSelect';
    select.innerHTML = '<option value="">-- Select Product --</option><option value="new">➕ Add New Product</option>';
    list.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.textContent = `${p.id} - ${p.name}`;
      select.appendChild(opt);
    });
    document.getElementById('root').appendChild(select);
    select.addEventListener('change', handleSelect);
  }

  /* ---------- empty skeleton ---------- */
  function newProduct() {
    const maxId = products.length ? Math.max(...products.map(p => +p.id)) : 0;
    return {
      id: String(maxId + 1).padStart(3, '0'),
      slug: '',
      name: '',
      active: true,
      categories: [],
      sku: '',
      stock: 0,
      rating: 0,
      reviewCount: 0,
      images: [],
      price: 0,
      offerPrice: 0,
      qtyDiscount: {},
      shortDesc: '',
      longDesc: '',
      specialNote: '',
      related: [],
      metaTitle: '',
      metaDescription: '',
      ActiveSalt: '',
      reviews: []
    };
  }

  /* ---------- show form ---------- */
  function handleSelect(e) {
    const id = e.target.value;
    const prod = id === 'new' ? newProduct() : products.find(p => p.id === id);
    buildForm(prod);
  }

  /* ---------- build form ---------- */
  function buildForm(prod) {
    const form = document.createElement('form');
    Object.entries(prod).forEach(([k, v]) => {
      const lbl = document.createElement('label');
      lbl.textContent = k;
      form.appendChild(lbl);

      let input;
      if (typeof v === 'boolean') {
        input = document.createElement('input');
        input.type = 'checkbox';
        input.checked = v;
      } else if (typeof v === 'number') {
        input = document.createElement('input');
        input.type = 'number';
        input.value = v;
      } else if (['longDesc', 'metaDescription', 'specialNote'].includes(k)) {
        input = document.createElement('textarea');
        input.rows = 3;
        input.value = v;
      } else if (k === 'qtyDiscount') {
        input = document.createElement('textarea');
        input.rows = 3;
        input.value = JSON.stringify(v, null, 2);
      } else {
        input = document.createElement('input');
        input.type = 'text';
        input.value = Array.isArray(v) ? v.join(', ') : v;
      }
      input.name = k;
      form.appendChild(input);
    });

    const save = document.createElement('button');
    save.textContent = 'Save to GitHub';
    save.onclick = () => saveProduct(prod);
    form.appendChild(save);
    document.getElementById('root').appendChild(form);
  }

  /* ---------- save ---------- */
  async function saveProduct(prod) {
    const form = document.querySelector('form');
    const data = {};
    [...form.elements].forEach(el => {
      if (!el.name) return;
      let val = el.type === 'checkbox' ? el.checked : el.value;
      if (['categories', 'related', 'images'].includes(el.name)) val = val.split(',').map(s => s.trim()).filter(Boolean);
      if (el.name === 'qtyDiscount') try { val = JSON.parse(val); } catch { val = {}; }
      if (['stock', 'price', 'rating', 'reviewCount'].includes(el.name)) val = Number(val);
      data[el.name] = val;
    });

    const updated = [...products.filter(p => p.id !== data.id), data];
    const content = `export default ${JSON.stringify(updated, null, 2)};`;
    const body = {
      message: 'Admin update',
      content: btoa(content),
      sha: await getFileSha(),
      branch: 'main'
    };
    const res = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
      method: 'PUT',
      headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
      body: JSON.stringify(body)
    });
    if (res.ok) {
      alert('✅ Saved!');
      window.location.reload();
    } else {
      alert('❌ ' + (await res.json()).message);
    }
  }

  /* ---------- helpers ---------- */
  async function getFileSha() {
    const res = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}?ref=${branch}`);
    const json = await res.json();
    return json.sha;
  }

  /* ---------- init ---------- */
  loadProducts();
</script>


</body>
</html>